<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RP2040 Config Viewer</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    table { border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background: #f0f0f0; }
    #log { margin-top: 1rem; white-space: pre; background: #eee; padding: 1rem; }
  </style>
</head>
<body>

<h1>RP2040 SysEx Config Viewer</h1>
<div id="status">üîå Connect your device via USB MIDI...</div>

<table id="config-table" style="display:none;">
  <thead>
    <tr><th>Field</th><th>Value</th></tr>
  </thead>
  <tbody></tbody>
</table>

<pre id="log">Log will appear here...</pre>

<script>
let midiInput = null;
let midiOutput = null;

const log = msg => {
  const el = document.getElementById('log');
  el.textContent += msg + '\n';
};

function decode7bit(payload) {
  const result = [];
  for (let i = 0; i < payload.length; i += 2) {
    result.push((payload[i] & 0x7F) | (payload[i + 1] << 7));
  }
  return result;
}

function parseConfig(decoded) {
  let i = 0;
  const magic = decoded[i++] |
               (decoded[i++] << 8) |
               (decoded[i++] << 16) |
               (decoded[i++] << 24);
  const bpm = decoded[i++] | (decoded[i++] << 8);
  const divide = decoded[i++];
  const cvRange = decoded[i++];

  const preset = [];
  for (let p = 0; p < 2; p++) {
    preset.push({
      scale: decoded[i++],
      notes: decoded[i++],
      range: decoded[i++],
      length: decoded[i++],
      looplen: decoded[i++],
      pulseMode1: decoded[i++],
      pulseMode2: decoded[i++]
    });
  }

  return { magic, bpm, divide, cvRange, preset };
}

function renderConfig(config) {
  const table = document.getElementById('config-table');
  const tbody = table.querySelector('tbody');
  tbody.innerHTML = ''; // clear previous

  const addRow = (label, value) => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${label}</td><td>${value}</td>`;
    tbody.appendChild(row);
  };

  addRow("Magic", `0x${config.magic.toString(16)}`);
  addRow("BPM", config.bpm);
  addRow("Divide", config.divide);
  addRow("CV Range", config.cvRange);

  config.preset.forEach((p, idx) => {
    addRow(`Preset ${idx} - Scale`, p.scale);
    addRow(`Preset ${idx} - Notes`, p.notes);
    addRow(`Preset ${idx} - Range`, p.range);
    addRow(`Preset ${idx} - Length`, p.length);
    addRow(`Preset ${idx} - Loop Length`, p.looplen);
    addRow(`Preset ${idx} - Pulse Mode 1`, p.pulseMode1);
    addRow(`Preset ${idx} - Pulse Mode 2`, p.pulseMode2);
  });

  table.style.display = 'table';
}

function onMIDIMessage(event) {
  const data = Array.from(event.data);
  if (data[0] === 0xF0 && data[1] === 0x7D && data[2] === 0x01 && data[3] === 0x02) {
    const payload = data.slice(4, -1); // Exclude start and end bytes
    const decoded = payload;
    const config = parseConfig(decoded);
    log("üì• Received SysEx Config Dump:");
    log(JSON.stringify(config, null, 2));
    renderConfig(config);
    document.getElementById('status').textContent = "‚úÖ Device connected and config received";
  } else {
    log("üì• MIDI: " + data.join(", "));
  }
}

function tryToConnect(midiAccess) {
  for (const entry of midiAccess.outputs.values()) {
    if (!midiOutput && entry.name.includes("Computer")) {
      midiOutput = entry;
    }
  }
  for (const entry of midiAccess.inputs.values()) {
    if (!midiInput && entry.name.includes("Computer")) {
      midiInput = entry;
    }
  }

  if (midiInput && midiOutput) {
    midiInput.onmidimessage = onMIDIMessage;
    document.getElementById('status').textContent = `üîç Found ${midiInput.name}, requesting config...`;

    const hello = new Uint8Array([0xF0, 0x7D, 0x01, 0x01, 0xF7]);
    midiOutput.send(hello);
    log("üì§ Sent SysEx: Hello");
  } else {
    log("üïê Still waiting for device...");
  }
}

navigator.requestMIDIAccess({ sysex: true }).then(midiAccess => {
  tryToConnect(midiAccess);

  midiAccess.onstatechange = e => {
    log(`‚ö° MIDI state changed: ${e.port.name} ${e.port.state}`);
    tryToConnect(midiAccess);
  };
}).catch(err => {
  log("‚ùå MIDI Access Error: " + err.message);
});
</script>

</body>
</html>
